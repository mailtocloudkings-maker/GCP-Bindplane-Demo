name: BindPlane GCP Demo Deployment

on:
  workflow_dispatch:

env:
  TF_VERSION: 1.6.6
  TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
  TF_VAR_region: ${{ secrets.GCP_REGION }}
  TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
  TF_VAR_admin_password: ${{ secrets.BINDPLANE_ADMIN_PASSWORD }}

jobs:

# =========================================================
#  CLOUD SQL POSTGRESQL
# =========================================================
  part1-db:
    name: Cloud SQL PostgreSQL
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Terraform Init – Cloud SQL
        working-directory: terraform/part1-db
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ steps.auth.outputs.credentials_file_path }}
          CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE: ${{ steps.auth.outputs.credentials_file_path }}
        run: terraform init

      - name: Terraform Apply – Cloud SQL
        working-directory: terraform/part1-db
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ steps.auth.outputs.credentials_file_path }}
          CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE: ${{ steps.auth.outputs.credentials_file_path }}
        run: terraform apply -auto-approve

# =========================================================
#  BINDPLANE CONTROL PLANE
# =========================================================
  part2-control-plane:
    name: BindPlane Control Plane
    runs-on: ubuntu-latest
    needs: part1-db

    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Terraform Init – Control Plane
        working-directory: terraform/part2-control-plane
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ steps.auth.outputs.credentials_file_path }}
          CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE: ${{ steps.auth.outputs.credentials_file_path }}
        run: terraform init

      - name: Terraform Apply – Control Plane
        working-directory: terraform/part2-control-plane
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ steps.auth.outputs.credentials_file_path }}
          CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE: ${{ steps.auth.outputs.credentials_file_path }}
        run: terraform apply -auto-approve

      - name: Output Internal IP
        working-directory: terraform/part2-control-plane
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ steps.auth.outputs.credentials_file_path }}
          CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE: ${{ steps.auth.outputs.credentials_file_path }}
        run: |
          CP_IP=$(terraform output -raw control_plane_internal_ip)
          echo "BindPlane Control Plane Internal IP: $CP_IP"

# =========================================================
#  BINDPLANE AGENTS
# =========================================================
  part3-agents:
    name: BindPlane Agents
    runs-on: ubuntu-latest
    needs: part2-control-plane

    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Terraform Init – Agents
        working-directory: terraform/part3-agents
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ steps.auth.outputs.credentials_file_path }}
          CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE: ${{ steps.auth.outputs.credentials_file_path }}
        run: terraform init

      - name: Terraform Apply – Agents
        working-directory: terraform/part3-agents
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ steps.auth.outputs.credentials_file_path }}
          CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE: ${{ steps.auth.outputs.credentials_file_path }}
        run: terraform apply -auto-approve
